# UniswapV1 è‡ªå­¦ç³»åˆ— 02 - å®šä»·åŠŸèƒ½å®ç°

åœ¨ UniswapV1 ç³»åˆ—çš„ç¬¬äºŒç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€çš„æ ¸å¿ƒæœºåˆ¶ï¼šå®šä»·åŠŸèƒ½çš„è®¾è®¡ä¸å®ç°ã€‚

## å®šä»·æœºåˆ¶çš„æ€è€ƒ

### 1.1 ç›´è§‚çš„å®šä»·æ€è·¯

åˆå­¦è€…å¯èƒ½ä¼šè®¤ä¸ºï¼Œå»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€çš„ä»·æ ¼è®¡ç®—å°±æ˜¯ç®€å•çš„å‚¨å¤‡æ¯”ä¾‹å…³ç³»ï¼š

![](images/The-relationship-between-price-and-reserve-quantity.png)

å…¶ä¸­ï¼š
- `P_X` è¡¨ç¤ºä»£å¸Xç›¸å¯¹äºä»£å¸Yçš„ä»·æ ¼
- `x` å’Œ `y` åˆ†åˆ«è¡¨ç¤ºä¸¤ç§ä»£å¸çš„å‚¨å¤‡é‡

è¿™ç§æƒ³æ³•ç¡®å®æœ‰å…¶åˆç†æ€§ã€‚ä¸ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ä¸åŒï¼Œå»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€åˆçº¦æ— æ³•è·å–å¤–éƒ¨ä»·æ ¼ä¿¡æ¯ï¼Œå®ƒä»¬å¿…é¡»ä¾æ®è‡ªèº«æŒæœ‰çš„èµ„äº§å‚¨å¤‡æ¥ç¡®å®šä»·æ ¼ã€‚ä»è¿™ä¸ªè§’åº¦çœ‹ï¼ŒExchangeåˆçº¦æœ¬èº«å°±æ‰®æ¼”ç€ä»·æ ¼é¢„è¨€æœºçš„è§’è‰²ã€‚

### 1.2 ç®€å•å®šä»·å‡½æ•°çš„å®ç°

è®©æˆ‘ä»¬åŸºäºå‚¨å¤‡æ¯”ä¾‹çš„æ€è·¯ï¼Œå…ˆå®ç°ä¸€ä¸ªç®€å•çš„å®šä»·å‡½æ•°ï¼š

```solidity
/**
 * @dev åŸºäºå‚¨å¤‡æ¯”ä¾‹çš„ç®€å•å®šä»·å‡½æ•°
 * @param inputReserve è¾“å…¥ä»£å¸çš„å‚¨å¤‡é‡
 * @param outputReserve è¾“å‡ºä»£å¸çš„å‚¨å¤‡é‡
 * @return è¿”å›ä»·æ ¼æ¯”ä¾‹
 */
function getPrice(uint256 inputReserve, uint256 outputReserve)
    public
    pure
    returns (uint256)
{
    // ç¡®ä¿å‚¨å¤‡é‡ä¸ä¸ºé›¶ï¼Œé¿å…é™¤é›¶é”™è¯¯
    require(inputReserve > 0 && outputReserve > 0, "invalid reserves");

    // è¿”å›è¾“å…¥å‚¨å¤‡ä¸è¾“å‡ºå‚¨å¤‡çš„æ¯”ä¾‹
    return inputReserve / outputReserve;
}
```

### 1.3 æµ‹è¯•ç®€å•å®šä»·å‡½æ•°

è®©æˆ‘ä»¬ä½¿ç”¨ Foundry æµ‹è¯•æ¡†æ¶æ¥éªŒè¯å®šä»·å‡½æ•°çš„æ­£ç¡®æ€§ï¼š

```solidity
// åœ¨ ExchangeTest.t.sol ä¸­æ·»åŠ æµ‹è¯•å‡½æ•°
function testGetPriceSimpleImpl() public {
    vm.startPrank(user);

    // 1. æˆæƒå¹¶æ·»åŠ æµåŠ¨æ€§ï¼š2000ä¸ªä»£å¸ + 1000ä¸ªETH
    token.approve(address(exchange), 2000 ether);
    exchange.addLiquidity{value: 1000 ether}(2000 ether);

    // 2. è·å–å½“å‰å‚¨å¤‡é‡
    uint256 tokenReserve = exchange.getReserve();
    uint256 etherReserve = address(exchange).balance;

    // 3. æµ‹è¯•ä»·æ ¼è®¡ç®—
    // ETHç›¸å¯¹äºTokençš„ä»·æ ¼ï¼ˆåº”è¯¥æ˜¯0.5ï¼‰
    uint256 ethPerToken = exchange.getPrice(etherReserve, tokenReserve);
    assertEq(ethPerToken, 0); // æ³¨æ„ï¼šè¿™é‡Œä¼šå¤±è´¥ï¼

    // Tokenç›¸å¯¹äºETHçš„ä»·æ ¼ï¼ˆåº”è¯¥æ˜¯2ï¼‰
    uint256 tokenPerEth = exchange.getPrice(tokenReserve, etherReserve);
    assertEq(tokenPerEth, 2);

    vm.stopPrank();
}
```

```bash
forge test --match-test testGetPriceSimpleImpl -v
```

![æµ‹è¯•è¿è¡Œç»“æœ](images/SCR-20250914-qmta.png)

## 2. æ•´æ•°é™¤æ³•ç²¾åº¦é—®é¢˜

### 2.1 é—®é¢˜åˆ†æ

æŒ‰ç…§æˆ‘ä»¬çš„é¢„æœŸï¼Œå­˜å…¥2000ä¸ªä»£å¸å’Œ1000ä¸ªETHåï¼Œä»£å¸ä»·æ ¼åº”è¯¥æ˜¯0.5 ETHï¼ŒETHä»·æ ¼åº”è¯¥æ˜¯2ä¸ªä»£å¸ã€‚ä½†æ˜¯æµ‹è¯•å´å¤±è´¥äº†ï¼Œæ˜¾ç¤ºä»£å¸ä»·æ ¼ä¸º0ã€‚

**æ ¹æœ¬åŸå› ï¼š**Solidityåªæ”¯æŒæ•´æ•°è¿ç®—ï¼Œé™¤æ³•è¿ç®—ä¼šè‡ªåŠ¨å‘ä¸‹å–æ•´ã€‚å½“è®¡ç®— `1000/2000 = 0.5` æ—¶ï¼Œç»“æœè¢«æˆªæ–­ä¸º0ï¼

### 2.2 ç²¾åº¦ä¼˜åŒ–æ–¹æ¡ˆ

ä¸ºäº†è§£å†³ç²¾åº¦é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥æ”¾å¤§å› å­ï¼š

```solidity
/**
 * @dev æ”¹è¿›çš„å®šä»·å‡½æ•°ï¼Œä½¿ç”¨1000å€æ”¾å¤§å› å­æé«˜ç²¾åº¦
 * @param inputReserve è¾“å…¥ä»£å¸çš„å‚¨å¤‡é‡
 * @param outputReserve è¾“å‡ºä»£å¸çš„å‚¨å¤‡é‡
 * @return è¿”å›ä»·æ ¼æ¯”ä¾‹ï¼ˆæ”¾å¤§1000å€ï¼‰
 */
function getPrice(uint256 inputReserve, uint256 outputReserve)
    public
    pure
    returns (uint256)
{
    require(inputReserve > 0 && outputReserve > 0, "invalid reserves");

    // ä½¿ç”¨1000å€æ”¾å¤§å› å­é¿å…ç²¾åº¦ä¸¢å¤±
    return (inputReserve * 1000) / outputReserve;
}
```

### 2.3 æ›´æ–°åçš„æµ‹è¯•

```solidity
function testGetPriceWithPrecision() public {
    vm.startPrank(user);

    // æ·»åŠ æµåŠ¨æ€§ï¼š2000ä¸ªä»£å¸ + 1000ä¸ªETH
    token.approve(address(exchange), 2000 ether);
    exchange.addLiquidity{value: 1000 ether}(2000 ether);

    uint256 tokenReserve = exchange.getReserve();
    uint256 etherReserve = address(exchange).balance;

    // ETHç›¸å¯¹äºTokençš„ä»·æ ¼ï¼š1000*1000/2000 = 500ï¼ˆè¡¨ç¤º0.5ï¼‰
    uint256 ethPerToken = exchange.getPrice(etherReserve, tokenReserve);
    assertEq(ethPerToken, 500);

    // Tokenç›¸å¯¹äºETHçš„ä»·æ ¼ï¼š2000*1000/1000 = 2000ï¼ˆè¡¨ç¤º2.0ï¼‰
    uint256 tokenPerEth = exchange.getPrice(tokenReserve, etherReserve);
    assertEq(tokenPerEth, 2000);

    vm.stopPrank();
}
```

è¿è¡Œæµ‹è¯•éªŒè¯ç»“æœï¼š

```bash
forge test --match-test testGetPriceWithPrecision -v
```

![æµ‹è¯•è¿è¡Œç»“æœ](images/SCR-20250914-qzsh.png)


ç°åœ¨ä»·æ ¼è®¡ç®—æ­£ç¡®äº†ï¼š1ä¸ªä»£å¸ = 0.5 ETHï¼Œ1ä¸ªETH = 2ä¸ªä»£å¸ã€‚

## 3. ç®€å•å®šä»·å‡½æ•°çš„è‡´å‘½ç¼ºé™·

### 3.1 èµ„é‡‘æ± æ¯ç«­é—®é¢˜

è™½ç„¶ä»·æ ¼è®¡ç®—çœ‹èµ·æ¥åˆç†ï¼Œä½†è¿™ä¸ªå®šä»·å‡½æ•°å­˜åœ¨ä¸¥é‡é—®é¢˜ã€‚å‡è®¾æœ‰ç”¨æˆ·æƒ³è¦ç”¨å…¨éƒ¨çš„2000ä¸ªä»£å¸æ¢å–ETHï¼ŒæŒ‰ç…§å½“å‰ä»·æ ¼ï¼Œä»–ä»¬åº”è¯¥å¾—åˆ°1000ä¸ªETHâ€”â€”è¿™æ­£å¥½æ˜¯åˆçº¦ä¸­çš„å…¨éƒ¨ETHå‚¨å¤‡ï¼

**é—®é¢˜æ ¸å¿ƒï¼š**è¿™ç§å®šä»·æœºåˆ¶ä¼šå¯¼è‡´äº¤æ˜“æ‰€èµ„é‡‘å®Œå…¨æ¯ç«­ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ç»“æœã€‚

### 3.2 å¸¸æ•°å’Œå…¬å¼çš„æ•°å­¦é—®é¢˜

è¿™ä¸ªå®šä»·å‡½æ•°å®é™…ä¸Šéµå¾ªçš„æ˜¯**å¸¸æ•°å’Œå…¬å¼ï¼ˆConstant Sum Formulaï¼‰**ï¼š

```
k = x + yï¼ˆå¸¸æ•°ï¼‰
```

ä»æ•°å­¦è§’åº¦çœ‹ï¼Œè¿™ä¸ªå…¬å¼æè¿°çš„æ˜¯ä¸€æ¡ç›´çº¿ï¼Œå®ƒä¼šä¸xè½´å’Œyè½´ç›¸äº¤ã€‚è¿™æ„å‘³ç€åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå‚¨å¤‡é‡å¯èƒ½é™è‡³0ï¼Œè¿™æ­£æ˜¯å¯¼è‡´èµ„é‡‘æ± æ¯ç«­çš„æ ¹æœ¬åŸå› ã€‚

<img src="images/Constant-formula.png" style="zoom:50%;" />


**å…³é”®é—®é¢˜ï¼š**ç›´çº¿å‡½æ•°å…è®¸ä»»ä¸€å‚¨å¤‡é‡å½’é›¶ï¼Œè¿™ä¸å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€éœ€è¦ç»´æŒæŒç»­æµåŠ¨æ€§çš„è¦æ±‚ç›¸çŸ›ç›¾ã€‚

## 4. æ’å®šä¹˜ç§¯å…¬å¼ï¼šæ­£ç¡®çš„è§£å†³æ–¹æ¡ˆ

### 4.1 UniswapV1çš„æ ¸å¿ƒç†å¿µ

Uniswapé‡‡ç”¨çš„æ˜¯**æ’å®šä¹˜ç§¯åšå¸‚å•†ï¼ˆConstant Product Market Makerï¼‰**æœºåˆ¶ï¼Œå…¶æ•°å­¦åŸºç¡€æ˜¯æ’å®šä¹˜ç§¯å…¬å¼ï¼š

```
x Ã— y = kï¼ˆå¸¸æ•°ï¼‰
```

å…¶ä¸­ï¼š
- `x` å’Œ `y` åˆ†åˆ«è¡¨ç¤ºä¸¤ç§ä»£å¸çš„å‚¨å¤‡é‡
- `k` æ˜¯ä¸€ä¸ªæ’å®šçš„ä¹˜ç§¯å€¼

è¿™ä¸ªå…¬å¼æ˜¯å¦èƒ½è§£å†³æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜å‘¢ï¼Ÿè®©æˆ‘ä»¬æ·±å…¥åˆ†æã€‚

### 4.2 äº¤æ˜“è¿‡ç¨‹çš„æ•°å­¦å»ºæ¨¡

æ’å®šä¹˜ç§¯å…¬å¼ç¡®ä¿äº†æ— è®ºå‚¨å¤‡é‡å¦‚ä½•å˜åŒ–ï¼Œä¹˜ç§¯ `k` å§‹ç»ˆä¿æŒä¸å˜ã€‚åœ¨æ¯ç¬”äº¤æ˜“ä¸­ï¼š

- ç”¨æˆ·æŠ•å…¥ `Î”x` æ•°é‡çš„ä»£å¸A
- è·å¾— `Î”y` æ•°é‡çš„ä»£å¸B
- äº¤æ˜“åå‚¨å¤‡é‡å˜ä¸º `(x+Î”x)` å’Œ `(y-Î”y)`

äº¤æ˜“å‰åæ’å®šä¹˜ç§¯å…³ç³»çš„æ•°å­¦è¡¨è¾¾ï¼š

```
(x + Î”x)(y - Î”y) = xy
```

è¿™ä¸ªç­‰å¼ç¡®ä¿äº†äº¤æ˜“å‰åä¹˜ç§¯ä¿æŒä¸å˜ã€‚

### 4.3 æ¨å¯¼è¾“å‡ºé‡‘é¢å…¬å¼

é€šè¿‡å¯¹æ’å®šä¹˜ç§¯ç­‰å¼è¿›è¡Œä»£æ•°å˜æ¢ï¼Œæˆ‘ä»¬å¯ä»¥æ±‚å‡ºè¾“å‡ºé‡‘é¢ `Î”y`ï¼š

```
å±•å¼€ï¼š(x + Î”x)(y - Î”y) = xy
åŒ–ç®€ï¼šxy - xÎ”y + yÎ”x - Î”xÎ”y = xy
æ¶ˆé™¤xyï¼š-xÎ”y + yÎ”x - Î”xÎ”y = 0
ç§»é¡¹ï¼šxÎ”y + Î”xÎ”y = yÎ”x
æå–Î”yï¼šÎ”y(x + Î”x) = yÎ”x
æ±‚è§£ï¼šÎ”y = (yÎ”x) / (x + Î”x)
```

**æœ€ç»ˆå…¬å¼ï¼š**
```
Î”y = (è¾“å‡ºå‚¨å¤‡ Ã— è¾“å…¥é‡‘é¢) / (è¾“å…¥å‚¨å¤‡ + è¾“å…¥é‡‘é¢)
```

è¿™ä¸ªå…¬å¼æœ‰ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼šè¾“å‡ºé‡‘é¢ç°åœ¨å–å†³äºè¾“å…¥é‡‘é¢ï¼Œè€Œä¸ä»…ä»…æ˜¯å‚¨å¤‡æ¯”ä¾‹ã€‚

### 4.4 å®ç°æ’å®šä¹˜ç§¯å®šä»·å‡½æ•°

ç°åœ¨æˆ‘ä»¬åŸºäºæ’å®šä¹˜ç§¯å…¬å¼æ¥å®ç°æ­£ç¡®çš„å®šä»·å‡½æ•°ã€‚æ³¨æ„ï¼šæˆ‘ä»¬ç°åœ¨å¤„ç†çš„æ˜¯å…·ä½“çš„äº¤æ˜“é‡‘é¢ï¼Œè€Œä¸æ˜¯æŠ½è±¡çš„ä»·æ ¼æ¯”ä¾‹ã€‚

```solidity
/**
 * @dev åŸºäºæ’å®šä¹˜ç§¯å…¬å¼çš„é‡‘é¢è®¡ç®—å‡½æ•°
 * @param inputAmount ç”¨æˆ·è¾“å…¥çš„ä»£å¸æ•°é‡
 * @param inputReserve è¾“å…¥ä»£å¸çš„å½“å‰å‚¨å¤‡é‡
 * @param outputReserve è¾“å‡ºä»£å¸çš„å½“å‰å‚¨å¤‡é‡
 * @return ç”¨æˆ·èƒ½å¤Ÿè·å¾—çš„è¾“å‡ºä»£å¸æ•°é‡
 */
function getAmount(
    uint256 inputAmount,
    uint256 inputReserve,
    uint256 outputReserve
) private pure returns (uint256) {
    // ç¡®ä¿å‚¨å¤‡é‡å’Œè¾“å…¥é‡‘é¢æœ‰æ•ˆ
    require(inputReserve > 0 && outputReserve > 0, "invalid reserves");
    require(inputAmount > 0, "invalid input amount");

    // åº”ç”¨æ’å®šä¹˜ç§¯å…¬å¼ï¼šÎ”y = (yÎ”x) / (x + Î”x)
    return (inputAmount * outputReserve) / (inputReserve + inputAmount);
}
```

### 4.5 é«˜çº§å°è£…å‡½æ•°

`getAmount` æ˜¯åº•å±‚è®¡ç®—å‡½æ•°ï¼Œæˆ‘ä»¬å°†å…¶è®¾ä¸ºç§æœ‰ã€‚ç°åœ¨åˆ›å»ºä¸¤ä¸ªé¢å‘ç”¨æˆ·çš„é«˜çº§å‡½æ•°ï¼Œåˆ†åˆ«å¤„ç†ETHâ†’ä»£å¸å’Œä»£å¸â†’ETHçš„å…‘æ¢ï¼š

```solidity
/**
 * @dev è®¡ç®—ç”¨ETHè´­ä¹°ä»£å¸çš„æ•°é‡
 * @param _ethSold å‡ºå”®çš„ETHæ•°é‡
 * @return èƒ½å¤Ÿè·å¾—çš„ä»£å¸æ•°é‡
 */
function getTokenAmount(uint256 _ethSold) public view returns (uint256) {
    require(_ethSold > 0, "ETH amount too small");

    uint256 tokenReserve = getReserve();
    uint256 ethReserve = address(this).balance;

    // è®¡ç®—ï¼šç”¨ETHä¹°ä»£å¸
    return getAmount(_ethSold, ethReserve, tokenReserve);
}

/**
 * @dev è®¡ç®—ç”¨ä»£å¸è´­ä¹°ETHçš„æ•°é‡
 * @param _tokenSold å‡ºå”®çš„ä»£å¸æ•°é‡
 * @return èƒ½å¤Ÿè·å¾—çš„ETHæ•°é‡
 */
function getEthAmount(uint256 _tokenSold) public view returns (uint256) {
    require(_tokenSold > 0, "Token amount too small");

    uint256 tokenReserve = getReserve();
    uint256 ethReserve = address(this).balance;

    // è®¡ç®—ï¼šç”¨ä»£å¸ä¹°ETH
    return getAmount(_tokenSold, tokenReserve, ethReserve);
}
```

### 4.6 æµ‹è¯•æ’å®šä¹˜ç§¯å®šä»·å‡½æ•°

è®©æˆ‘ä»¬ä½¿ç”¨Foundryæ¡†æ¶æµ‹è¯•æ–°çš„å®šä»·å‡½æ•°ï¼š

```solidity
function testGetTokenAmount() public {
    vm.startPrank(user);

    // 1. æ·»åŠ åˆå§‹æµåŠ¨æ€§ï¼š2000ä»£å¸ + 1000ETH
    token.approve(address(exchange), 2000 ether);
    exchange.addLiquidity{value: 1000 ether}(2000 ether);

    // 2. æµ‹è¯•ç”¨1ä¸ªETHè´­ä¹°ä»£å¸
    uint256 tokensOut = exchange.getTokenAmount(1 ether);

    // 3. éªŒè¯ç»“æœï¼ˆåº”çº¦ä¸º1.998ä»£å¸ï¼Œç•¥å°äº2ä»£å¸ï¼‰
    assertEq(tokensOut, 1998001998001998001);

    vm.stopPrank();
}

function testGetEthAmount() public {
    vm.startPrank(user);

    // 1. æ·»åŠ åˆå§‹æµåŠ¨æ€§
    token.approve(address(exchange), 2000 ether);
    exchange.addLiquidity{value: 1000 ether}(2000 ether);

    // 2. æµ‹è¯•ç”¨2ä¸ªä»£å¸è´­ä¹°ETH
    uint256 ethOut = exchange.getEthAmount(2 ether);

    // 3. éªŒè¯ç»“æœï¼ˆåº”çº¦ä¸º0.999ETHï¼Œç•¥å°äº1ETHï¼‰
    assertEq(ethOut, 999000999000999000);

    vm.stopPrank();
}
```

è¿è¡Œæµ‹è¯•ï¼š

```bash
forge test --match-test testGetTokenAmount -v
forge test --match-test testGetEthAmount -v
```

![æµ‹è¯•è¿è¡Œç»“æœ](images/SCR-20250914-rgzv.png)

## 5. ä»·æ ¼æ»‘ç‚¹æœºåˆ¶åˆ†æ

### 5.1 æµ‹è¯•ç»“æœåˆ†æ

æµ‹è¯•ç»“æœæ˜¾ç¤ºï¼š
- 1ä¸ªETH â†’ 1.998ä¸ªä»£å¸ï¼ˆè€Œé2ä¸ªï¼‰
- 2ä¸ªä»£å¸ â†’ 0.999ä¸ªETHï¼ˆè€Œé1ä¸ªï¼‰

è¿™äº›æ•°å€¼ä¸ç®€å•æ¯”ä¾‹è®¡ç®—çš„ç»“æœéå¸¸æ¥è¿‘ï¼Œä½†éƒ½ç•¥å°ä¸€äº›ã€‚è¿™ç§ç°è±¡èƒŒåæœ‰é‡è¦çš„ç»æµå­¦åŸç†ã€‚

### 5.2 åŒæ›²çº¿ç‰¹æ€§çš„æ•°å­¦æ„ä¹‰

<img src="images/SCR-20250914-ridc.png" alt="æµ‹è¯•è¿è¡Œç»“æœ" style="zoom:50%;" />

æ’å®šä¹˜ç§¯å…¬å¼ `xy = k` åœ¨æ•°å­¦ä¸Šæè¿°çš„æ˜¯ä¸€æ¡åŒæ›²çº¿ï¼Œè¿™ä¸ªå‡ ä½•ç‰¹æ€§å…·æœ‰é‡è¦æ„ä¹‰ï¼š

**å…³é”®ç‰¹æ€§ï¼š**

1. **æ°¸ä¸å½’é›¶**ï¼šåŒæ›²çº¿æ°¸è¿œä¸ä¼šä¸xè½´æˆ–yè½´ç›¸äº¤ï¼Œè¿™æ„å‘³ç€å‚¨å¤‡é‡æ°¸è¿œä¸ä¼šé™è‡³0
2. **æ— é™æµåŠ¨æ€§**ï¼šç†è®ºä¸Šå‚¨å¤‡æ˜¯"æ— é™"çš„ï¼Œåªæ˜¯è·å–æˆæœ¬è¶Šæ¥è¶Šé«˜
3. **è‡ªåŠ¨å¹³è¡¡**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨ç»´æŒä¸¤ç§èµ„äº§çš„å¹³è¡¡

### 5.3 ä»·æ ¼æ»‘ç‚¹æœºåˆ¶

**ä»·æ ¼æ»‘ç‚¹ï¼ˆPrice Slippageï¼‰**æ˜¯AMMçš„æ ¸å¿ƒç‰¹æ€§ï¼šäº¤æ˜“æ•°é‡ç›¸å¯¹å‚¨å¤‡é‡è¶Šå¤§ï¼Œå®é™…æˆäº¤ä»·æ ¼åç¦»ç†è®ºä»·æ ¼è¶Šå¤šã€‚

è¿™ç§æœºåˆ¶æœ‰åŒé‡ä½œç”¨ï¼š
- **ä¿æŠ¤ä½œç”¨**ï¼šé˜²æ­¢å¤§é¢äº¤æ˜“ç¬é—´æŠ½å¹²èµ„é‡‘æ± 
- **æ¿€åŠ±ä½œç”¨**ï¼šé¼“åŠ±å¥—åˆ©è€…åœ¨ä»·æ ¼åç¦»æ—¶è¿›è¡Œåå‘æ“ä½œï¼Œç»´æŒä»·æ ¼ç¨³å®š

æµ‹è¯•ä¸­å‡ºç°çš„"æ”¶ç›Šç•¥ä½"ç°è±¡æ­£ä½“ç°äº†æ»‘ç‚¹æœºåˆ¶çš„ä½œç”¨ã€‚è™½ç„¶è¡¨é¢ä¸Šçœ‹æ¯ç¬”äº¤æ˜“éƒ½æœ‰"æŸå¤±"ï¼Œä½†è¿™ä¸ªæœºåˆ¶å®é™…ä¸Šï¼š

1. **é˜²æ­¢æ¯ç«­**ï¼šç¡®ä¿èµ„é‡‘æ± ä¸ä¼šè¢«å¤§é¢äº¤æ˜“å®Œå…¨æŠ½å¹²
2. **ç¬¦åˆç»æµå­¦**ï¼šå®Œç¾å¥‘åˆä¾›æ±‚å…³ç³»â€”â€”éœ€æ±‚è¶Šå¤§ï¼Œæˆæœ¬è¶Šé«˜
3. **ç»´æŒç¨³å®š**ï¼šé€šè¿‡ä»·æ ¼è°ƒèŠ‚æœºåˆ¶ç»´æŒå¸‚åœºå¹³è¡¡

è¿™ä¸æ˜¯ç¼ºé™·ï¼Œè€Œæ˜¯ç²¾å¿ƒè®¾è®¡çš„ä¿æŠ¤æœºåˆ¶ã€‚

### 5.4 æ»‘ç‚¹æ•ˆåº”çš„æ·±åº¦æµ‹è¯•

è®©æˆ‘ä»¬é€šè¿‡å¯¹æ¯”ä¸åŒäº¤æ˜“è§„æ¨¡æ¥ç›´è§‚æ„Ÿå—æ»‘ç‚¹æ•ˆåº”ï¼š

```solidity
function testSlippageEffect() public {
    vm.startPrank(user);

    // åˆå§‹æµåŠ¨æ€§ï¼š2000ä»£å¸ + 1000ETH
    token.approve(address(exchange), 2000 ether);
    exchange.addLiquidity{value: 1000 ether}(2000 ether);

    // å°é¢äº¤æ˜“ï¼š1 ETH â†’ ? ä»£å¸
    uint256 tokens1 = exchange.getTokenAmount(1 ether);
    assertEq(tokens1, 1998001998001998001); // çº¦1.998ä»£å¸

    // ä¸­ç­‰äº¤æ˜“ï¼š100 ETH â†’ ? ä»£å¸
    uint256 tokens100 = exchange.getTokenAmount(100 ether);
    assertEq(tokens100, 181818181818181818181); // çº¦181.8ä»£å¸ï¼ˆæ»‘ç‚¹æ˜¾è‘—ï¼‰

    // å¤§é¢äº¤æ˜“ï¼š1000 ETH â†’ ? ä»£å¸
    uint256 tokens1000 = exchange.getTokenAmount(1000 ether);
    console.log("tokens1000", tokens1000);
    assertEq(tokens1000, 1000 ether); // æ­£å¥½1000ä»£å¸ï¼ˆæ¥è¿‘æé™ï¼‰

    vm.stopPrank();
}

function testReverseSlippage() public {
    vm.startPrank(user);

    // åˆå§‹æµåŠ¨æ€§ï¼š2000ä»£å¸ + 1000ETH
    token.approve(address(exchange), 2000 ether);
    exchange.addLiquidity{value: 1000 ether}(2000 ether);

    // å°é¢ï¼š2 ä»£å¸ â†’ ? ETH
    uint256 eth2 = exchange.getEthAmount(2 ether);
    assertEq(eth2, 999000999000999000); // çº¦0.999 ETH

    // ä¸­ç­‰ï¼š100 ä»£å¸ â†’ ? ETH
    uint256 eth100 = exchange.getEthAmount(100 ether);
    assertEq(eth100, 47619047619047619047); // çº¦47.6 ETH

    // å¤§é¢ï¼š2000 ä»£å¸ â†’ ? ETH
    uint256 eth2000 = exchange.getEthAmount(2000 ether);
    console.log("eth2000", eth2000);
    assertEq(eth2000, 500 ether); // æ­£å¥½500 ETHï¼ˆä¸€åŠå‚¨å¤‡ï¼‰

    vm.stopPrank();
}
```

![æµ‹è¯•è¿è¡Œç»“æœ](images/SCR-20250914-rndg.png)

### 5.5 æé™æƒ…å†µåˆ†æ

ä»æµ‹è¯•ç»“æœå¯ä»¥çœ‹å‡ºä¸€ä¸ªé‡è¦è§„å¾‹ï¼šå½“äº¤æ˜“é‡‘é¢æ¥è¿‘å‚¨å¤‡æ€»é‡æ—¶ï¼Œç”¨æˆ·æœ€å¤šåªèƒ½è·å¾—å¯¹åº”å‚¨å¤‡çš„50%ã€‚è¿™æ˜¯æ’å®šä¹˜ç§¯å…¬å¼çš„æ•°å­¦ç‰¹æ€§å†³å®šçš„ï¼Œç¡®ä¿äº†èµ„é‡‘æ± æ°¸è¿œä¸ä¼šå®Œå…¨æ¯ç«­ã€‚

## 6. æ€»ç»“ä¸æ€è€ƒ

### 6.1 å®šä»·å‡½æ•°çš„æ¼”è¿›

æˆ‘ä»¬çš„å®šä»·å‡½æ•°ç»å†äº†ä¸‰ä¸ªé˜¶æ®µï¼š

1. **ç®€å•æ¯”ä¾‹**ï¼š`ä»·æ ¼ = å‚¨å¤‡æ¯”ä¾‹`
   - ä¼˜ç‚¹ï¼šç›´è§‚æ˜“ç†è§£
   - ç¼ºç‚¹ï¼šä¼šå¯¼è‡´èµ„é‡‘æ± æ¯ç«­

2. **ç²¾åº¦ä¼˜åŒ–**ï¼šå¼•å…¥æ”¾å¤§å› å­è§£å†³æ•´æ•°é™¤æ³•é—®é¢˜
   - è§£å†³äº†è®¡ç®—ç²¾åº¦é—®é¢˜
   - ä½†ä»ç„¶å­˜åœ¨æ¯ç«­é£é™©

3. **æ’å®šä¹˜ç§¯**ï¼šåŸºäº`xy = k`çš„ç§‘å­¦å®šä»·
   - æ°¸ä¸æ¯ç«­çš„æ•°å­¦ä¿è¯
   - è‡ªå¸¦æ»‘ç‚¹ä¿æŠ¤æœºåˆ¶
   - ç¬¦åˆç»æµå­¦åŸç†

### 6.2 å…³é”®æ´å¯Ÿ

**ç®€å•æ¯”ä¾‹å®šä»·å¹¶éå®Œå…¨é”™è¯¯**â€”â€”å½“äº¤æ˜“é‡‘é¢ç›¸å¯¹å‚¨å¤‡é‡å¾ˆå°æ—¶ï¼Œå®ƒç»™å‡ºçš„ä»·æ ¼æ˜¯åˆç†çš„ã€‚ä½†è¦æ„å»ºçœŸæ­£çš„AMMç³»ç»Ÿï¼Œæˆ‘ä»¬éœ€è¦æ›´ç²¾å¯†çš„æ’å®šä¹˜ç§¯æœºåˆ¶ã€‚

è¿™ç§æ¸è¿›å¼çš„ç†è§£è¿‡ç¨‹ï¼Œæ­£æ˜¯å­¦ä¹ UniswapV1åŸç†çš„æœ€ä½³è·¯å¾„ï¼šä»ç›´è§‰å‡ºå‘ï¼Œå‘ç°é—®é¢˜ï¼Œé€æ­¥ä¼˜åŒ–ï¼Œæœ€ç»ˆæŒæ¡æ ¸å¿ƒæœºåˆ¶çš„æ•°å­¦ç²¾é«“ã€‚

**æŠ€æœ¯è¦ç‚¹å›é¡¾**

- æ’å®šä¹˜ç§¯å…¬å¼ï¼š`x Ã— y = k`
- äº¤æ˜“å…¬å¼ï¼š`Î”y = (yÎ”x) / (x + Î”x)`
- æ»‘ç‚¹ä¿æŠ¤ï¼šé˜²æ­¢èµ„é‡‘æ± æ¯ç«­çš„æ ¸å¿ƒæœºåˆ¶
- åŒæ›²çº¿ç‰¹æ€§ï¼šç¡®ä¿å‚¨å¤‡æ°¸ä¸å½’é›¶çš„æ•°å­¦åŸºç¡€

---

## ğŸ“š é¡¹ç›®ä»“åº“

å®Œæ•´é¡¹ç›®ä»£ç è¯·è®¿é—®ï¼š[https://github.com/RyanWeb31110/uniswapv1_tech](https://github.com/RyanWeb31110/uniswapv1_tech)

æœ¬ç³»åˆ—æ–‡ç« æ˜¯åŸºäºè¯¥é¡¹ç›®çš„å®Œæ•´æ•™å­¦å®ç°ï¼Œæ¬¢è¿å…‹éš†ä»£ç è¿›è¡Œå®è·µå­¦ä¹ ï¼